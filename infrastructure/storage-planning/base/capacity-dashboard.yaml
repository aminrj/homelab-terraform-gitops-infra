# infrastructure/storage-planning/base/capacity-dashboard.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: storage-capacity-dashboard
  namespace: monitoring
  labels:
    grafana_dashboard: "1"
data:
  storage-capacity.json: |
    {
      "dashboard": {
        "id": null,
        "title": "Storage Capacity Planning",
        "tags": ["storage", "capacity", "planning"],
        "style": "dark",
        "timezone": "UTC",
        "editable": true,
        "hideControls": false,
        "graphTooltip": 1,
        "panels": [
          {
            "id": 1,
            "title": "Node Storage Usage",
            "type": "stat",
            "targets": [
              {
                "expr": "(node_filesystem_size_bytes{job=\"node-exporter\",fstype!=\"\",mountpoint!=\"\"} - node_filesystem_avail_bytes{job=\"node-exporter\",fstype!=\"\",mountpoint!=\"\"}) / node_filesystem_size_bytes{job=\"node-exporter\",fstype!=\"\",mountpoint!=\"\"} * 100",
                "legendFormat": "{{instance}} {{mountpoint}}"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "min": 0,
                "max": 100,
                "unit": "percent",
                "thresholds": {
                  "steps": [
                    {"color": "green", "value": 0},
                    {"color": "yellow", "value": 75},
                    {"color": "red", "value": 85}
                  ]
                }
              }
            },
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0}
          },
          {
            "id": 2,
            "title": "PVC Usage Trends",
            "type": "timeseries",
            "targets": [
              {
                "expr": "kubelet_volume_stats_available_bytes{job=\"kubelet\",metrics_path=\"/metrics\"} / kubelet_volume_stats_capacity_bytes{job=\"kubelet\",metrics_path=\"/metrics\"} * 100",
                "legendFormat": "{{namespace}}/{{persistentvolumeclaim}}"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "min": 0,
                "max": 100,
                "unit": "percent"
              }
            },
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0}
          },
          {
            "id": 3,
            "title": "Database Growth Rate",
            "type": "timeseries",
            "targets": [
              {
                "expr": "increase(cnpg_pg_database_size_bytes[24h]) / cnpg_pg_database_size_bytes * 100",
                "legendFormat": "{{cluster}}/{{datname}}"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "percent",
                "thresholds": {
                  "steps": [
                    {"color": "green", "value": 0},
                    {"color": "yellow", "value": 10},
                    {"color": "red", "value": 20}
                  ]
                }
              }
            },
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8}
          },
          {
            "id": 4,
            "title": "Storage Forecast (7 days)",
            "type": "stat",
            "targets": [
              {
                "expr": "predict_linear(node_filesystem_avail_bytes{job=\"node-exporter\",fstype!=\"\",mountpoint!=\"\"}[7d], 7*24*3600) / 1024 / 1024 / 1024",
                "legendFormat": "{{instance}} {{mountpoint}} remaining GB"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "decgbytes",
                "thresholds": {
                  "steps": [
                    {"color": "red", "value": 0},
                    {"color": "yellow", "value": 10},
                    {"color": "green", "value": 50}
                  ]
                }
              }
            },
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8}
          },
          {
            "id": 5,
            "title": "Top Storage Consumers",
            "type": "table",
            "targets": [
              {
                "expr": "topk(10, kubelet_volume_stats_capacity_bytes{job=\"kubelet\",metrics_path=\"/metrics\"} - kubelet_volume_stats_available_bytes{job=\"kubelet\",metrics_path=\"/metrics\"})",
                "legendFormat": "{{namespace}}/{{persistentvolumeclaim}}",
                "format": "table"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "bytes"
              }
            },
            "gridPos": {"h": 8, "w": 24, "x": 0, "y": 16}
          }
        ],
        "time": {
          "from": "now-24h",
          "to": "now"
        },
        "timepicker": {
          "refresh_intervals": ["30s", "1m", "5m", "15m", "30m", "1h", "2h", "1d"]
        },
        "refresh": "5m"
      }
    }